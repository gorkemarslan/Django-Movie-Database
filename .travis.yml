language: python

python:
  - "3.9"

services:
  - docker
  - postgresql

before_install:
  - touch ./DjangoMovieDatabase/.env
  - echo DEBUG="$DEBUG" >> ./DjangoMovieDatabase/.env
  - echo SECRET_KEY="$SECRET_KEY" >> ./DjangoMovieDatabase/.env
  - echo OMDB_API_KEY="$OMDB_API_KEY" >> ./DjangoMovieDatabase/.env
  - echo POSTGRES_HOST="$POSTGRES_HOST" >> ./DjangoMovieDatabase/.env
  - echo POSTGRES_DB="$POSTGRES_DB" >> ./DjangoMovieDatabase/.env
  - echo POSTGRES_USER="$POSTGRES_USER" >> ./DjangoMovieDatabase/.env
  - echo POSTGRES_PASSWORD="$POSTGRES_PASSWORD" >> ./DjangoMovieDatabase/.env
  - echo ALLOWED_HOSTS="$ALLOWED_HOSTS" >> ./DjangoMovieDatabase/.env
  - cat ./DjangoMovieDatabase/.env
  - docker-compose up -d --build db
  - sleep 15
  - docker-compose up -d --build web
  - sleep 5
  - docker ps
  - docker-compose logs

script:
  - docker-compose exec web python manage.py migrate
  - docker-compose exec web python manage.py makemigrations
  - docker-compose exec web python manage.py test && flake8